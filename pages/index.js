import Head from "next/head";
import Card from "../components/home-page-card/card-home-page.component";
import {fetchImages} from "../lib/get-images";
import { useContext, useEffect} from "react";
import {ACTION_TYPES, StoreContext} from "../store/store-context";

export async function getStaticProps() {
    const data = await fetchImages();

    return {
        props: {
            photos: data
        }
    }
}

export default function Home({photos}) {
    const {dispatch, state} = useContext(StoreContext);


    useEffect(
        () => {
            dispatch({
                type: ACTION_TYPES.SET_INITIAL_IMAGES,
                payload: photos
            })
        }, []
    );


    const handleLikeButton = async (data) => {
 

        dispatch({
            type: ACTION_TYPES.UPDATE_INITIAL_IMAGES,
            payload: data.id
        })
 
        console.log(state.initial_images)
        const profile_image = data.profile_image.small;

        const sendData = {
            ...data,
            profile_image,
            user_liked_image: true,
            likes: data.likes + 1

        }
        try {
            const response = await fetch("/api/create-favourites", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(sendData),
            });

            const serverResponse = await response.json();

            if (serverResponse[0] !== undefined) {
                dispatch({
                    type: ACTION_TYPES.ADD_FAVOURITE_IMAGE,
                    payload: serverResponse[0]
                })
            }


        } catch (error) {

        }


    }

    const {initial_images} = state;

    return (
        <div>
            <Head>
                <title>Image App</title>
                <meta name="description" content="Generated by create next app"/>
                <link rel="icon" href="/favicon.ico"/>
            </Head>

            <main className="main">
                <div className="card-layout">
                    {
                        initial_images.map((props) => <Card handleLike={handleLikeButton}
                                                            key={props.id} {...props}   />)
                    }

                </div>

            </main>
        </div>
    );
}
